// =====================================================
// Extractor Remax - Schema Canonical v3.1
// Versi√≥n: v1.9
// Fecha: 2025-12-22
// =====================================================
// CHANGELOG v1.9:
// - Add: extraccion_exitosa flag (boolean)
// - Change: modalidad ‚Üí tipo_operacion
// - Homologaci√≥n con Schema Canonical v3.1
// - Spread operator en return final
// =====================================================

const itemData = $input.first().json;

// Extraer datos del input
const idOriginal = itemData.id || null;
const html = itemData.html || '';
const markdown = itemData.markdown || '';
const configGlobal = itemData.config_global || {};
const proyectosMaster = itemData.proyectos_master || [];

// Validar que tenemos datos b√°sicos
if (!html || html.length < 500) {
  return [{
    json: {
      _internal_id: idOriginal,
      extraccion_exitosa: false,
      errores: ['HTML insuficiente o ausente'],
      extractor_version: '1.7.0',
      core_version: '3.0'
    }
  }];
}

// ============================================================================
// CONFIGURACI√ìN
// ============================================================================

// TC din√°mico del config_global
const TC_OFICIAL = configGlobal.TIPO_CAMBIO_USD_BS_OFICIAL || 6.96;
const TC_PARALELO = configGlobal.TIPO_CAMBIO_USD_BS_PARALELO || 10.20;

console.log(`‚úÖ TC - Oficial: ${TC_OFICIAL} | Paralelo: ${TC_PARALELO}`);
console.log(`‚úÖ Proyectos Master: ${proyectosMaster.length}`);
console.log(`‚úÖ HTML length: ${html.length} chars`);

const CONFIG = {
  VERSION: "1.7.0",
  CORE_VERSION: "3.0",
  TIPO_CAMBIO_USD_BS_OFICIAL: TC_OFICIAL,
  TIPO_CAMBIO_USD_BS_PARALELO: TC_PARALELO,
  MEDIA_ZONA_USD_M2: {
    "Equipetrol": 2461,
    "Equipetrol Norte": 2461,
    "Equipetrol/NorOeste": 2461,
    "Los Cusis": 1200,
    "Urubo": 1500,
    "Las Palmas": 1700,
    "Centro": 1000,
    "Norte": 900,
    "Sur": 800,
    "default": 1200
  }
};

const PROYECTOS_MASTER = proyectosMaster;

const ZONAS_GEOGRAFICAS = [
  'equipetrol', 'equipetrol norte', 'equipetrol sur', 'equipetrol oeste',
  'santa cruz', 'bolivia', 'zona norte', 'zona sur', 'centro',
  'radial', 'barrio', 'sirari', 'urubo', 'las palmas'
];

const BLACKLIST_CRITICA = [
  'remax', 'remax bolivia', 'century21', 'century 21',
  'departamento', 'casa', 'oficina', 'local', 'terreno',
  'hermoso', 'bonito', 'lindo', 'moderno', 'excelente',
  'oportunidad', 'invierte', 'consultar', 'en venta', 'se vende'
];

// ============================================================================
// INICIALIZAR RESULTADO
// ============================================================================

const resultado = {
  _internal_id: idOriginal,
  extraccion_exitosa: false,
  extractor_version: CONFIG.VERSION,
  core_version: CONFIG.CORE_VERSION,
  errores: []
};

// ============================================================================
// PARSEAR JSON DE REMAX
// ============================================================================
let listing = null;

try {
  console.log('üîç Buscando data-page en HTML...');
  listing = parsearDataPage(html);  // ‚Üê Usa la funci√≥n que S√ç funciona
  
  if (!listing) {
    console.error('‚ùå No se pudo extraer listing');
    resultado.errores.push('No se encontr√≥ data-page o estructura inv√°lida');
  } else {
    console.log('‚úÖ listing extra√≠do correctamente');
  }
} catch (e) {
  console.error('‚ùå Error parseando:', e.message);
  resultado.errores.push(`Error parseando data-page: ${e.message}`);
}
// ============================================================================
// UTILIDADES
// ============================================================================

function buscarPatron(texto, patron) {
    if (!texto || typeof texto !== 'string') return null;
    return texto.match(patron);
}

function limpiarContextoNoRelacionado(descripcion) {
    if (!descripcion || typeof descripcion !== 'string') return "";
    descripcion = descripcion.replace(/[\r\n]+/g, ' ').trim();
    return descripcion
        .replace(/parqueo\s+(?:opcional\s+)?(?:a\s+parte|aparte\s+)?(?:en|por|:)\s*(?:\$?\s?(?:us\.?|usd)?\s?[\d.,]+|[\d.,]+\s?(?:\$|us\.?|usd))/gi, '[PARQUEO]')
        .replace(/estacionamiento\s+(?:opcional\s+)?(?:a\s+parte|aparte\s+)?(?:en|por|:)\s*(?:\$?\s?(?:us\.?|usd)?\s?[\d.,]+|[\d.,]+\s?(?:\$|us\.?|usd))/gi, '[PARQUEO]');
}

function detectarTipoCambio(descripcion = "") {
    if (!descripcion || typeof descripcion !== 'string') return "no_especificado";
    const desc = descripcion.toLowerCase();
    if (/\b(?:tc\s*paralelo|cambio\s+paralelo|d√≥lar\s+blue)\b/i.test(desc)) return "paralelo";
    if (/\bpago\s+en\s+d√≥lares/i.test(desc)) return "paralelo";
    if (/tc\.?\s*oficial|\btc\.?\s*[67]\b/i.test(desc)) return "oficial";
    return "no_especificado";
}

function normalizarTextoParaMatch(texto) {
    if (!texto) return '';
    return texto.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
}

function wordIntersection(texto1, texto2) {
    const words1 = new Set(normalizarTextoParaMatch(texto1).split(/\s+/).filter(w => w.length >= 3));
    const words2 = new Set(normalizarTextoParaMatch(texto2).split(/\s+/).filter(w => w.length >= 3));
    if (words1.size === 0 || words2.size === 0) return 0;
    const intersection = [...words1].filter(w => words2.has(w)).length;
    const union = new Set([...words1, ...words2]).size;
    return union > 0 ? intersection / union : 0;
}

function limpiarZonasGeograficas(nombre) {
    if (!nombre) return '';
    let limpio = nombre;
    ZONAS_GEOGRAFICAS.forEach(zona => {
        const regex = new RegExp(`[\\s,]?${zona}[\\s,]?$`, 'gi');
        limpio = limpio.replace(regex, '');
    });
    return limpio.trim();
}

// ============================================================================
// PARSEAR DATA-PAGE
// ============================================================================

function parsearDataPage(html) {
    try {
        // ‚úÖ Regex flexible - solo busca data-page="..."
        const match = html.match(/data-page="([^"]*?)"/i);
        
        if (!match || !match[1]) {
            return null;
        }
        
        // Decodificar entidades HTML
        let jsonString = match[1]
            .replace(/&quot;/g, '"')
            .replace(/&amp;/g, '&')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>');
        
        // Parsear JSON
        const data = JSON.parse(jsonString);
        
        // Extraer listing de la estructura
        const listing = data.props?.listing || data.props?.property || data.listing || null;
        
        if (!listing) {
            return null;
        }
        
        return listing;
        
    } catch (error) {
        return null;
    }
}

// ============================================================================
// DETECCI√ìN INACTIVA TEMPRANA
// ============================================================================

function detectarInactivaTemprana(html) {
    if (!html || typeof html !== 'string') return null;
    const razones = [];
    if (html.trim().length < 300) {
        razones.push(`HTML corto (${html.trim().length} chars)`);
    }
    const titleMatch = html.match(/<title[^>]*>([\s\S]*?)<\/title>/i);
    if (titleMatch) {
        const title = titleMatch[1].toLowerCase();
        if (title.includes("404") || title.includes("no encontrada")) {
            razones.push(`T√≠tulo: "${titleMatch[1].trim()}"`);
        }
    }
    const bodyMatch = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
    if (bodyMatch) {
        const bodyContent = bodyMatch[1].toLowerCase();
        if (bodyContent.includes("esta propiedad ya no est√° disponible") ||
            bodyContent.includes("propiedad no disponible") ||
            bodyContent.includes("listing not found")) {
            razones.push("Mensaje de no disponible en body");
        }
    }
    if (razones.length > 0) {
        return {
            es_inactiva: true,
            razon: razones.join(", "),
            deteccion: "inactiva_temprana"
        };
    }
    return null;
}

// ============================================================================
// PRECIO
// ============================================================================

function parsePrecioMeta(raw) {
    if (!raw || typeof raw !== 'string') return null;
    raw = raw.trim().replace(/\s+/g, '');
    const esK = /k$/i.test(raw);
    if (esK) {
        raw = raw.replace(/k$/i, '');
        const num = parseFloat(raw);
        return !isNaN(num) && num > 0 ? num * 1000 : null;
    }
    if (raw.includes(".") && raw.includes(",")) {
        raw = raw.indexOf(".") < raw.indexOf(",") ? raw.replace(/\./g, "").replace(",", ".") : raw.replace(/,/g, "");
    } else if (raw.includes(",")) {
        const partes = raw.split(",");
        const decimales = partes[partes.length - 1];
        if (decimales.length >= 3 && !partes[2]) {
            raw = raw.replace(/,/g, "");
        } else {
            raw = raw.replace(",", ".");
        }
    } else if (raw.includes(".")) {
        const partes = raw.split(".");
        const decimales = partes[partes.length - 1];
        if (partes.length > 2 || (partes.length === 2 && decimales.length === 3)) {
            raw = raw.replace(/\./g, "");
        }
    }
    const num = parseFloat(raw);
    if (isNaN(num)) return null;
    if (num > 10000000) {
        const digitos = Math.floor(Math.log10(num)) + 1;
        if (digitos > 8) {
            return num / Math.pow(10, digitos - 6);
        }
    }
    return Math.round(num);
}

function extraerPrecio(listing, descripcion = "", esMultiproyecto = false) {
    const descripcionLimpia = limpiarContextoNoRelacionado(typeof descripcion === 'string' ? descripcion : "");
    let precio_bruto = null;
    let currency_id = null;
    let fuente_precio = "no_detectado";

    if (listing.prices && listing.prices.amount) {
        precio_bruto = listing.prices.amount;
        currency_id = listing.prices.currency_id;
        fuente_precio = "json_prices";
    }

    let precioExplicitoDesc = null;
    const patronesDesc = [
        /(?:precio|desde)\s*:?\s*\$\s?([\d.,]+)(?:\s+a\s+tc)/i,
        /(?:precio|desde)\s*:?\s*\$?\s?(?:us\.?|usd)\s?([\d.,]+)(?!\s*\/\s*m|\s*por\s*m)/i,
        /(\d[\d.,]+)\s*\$?\s?(?:us\.?|usd)(?!\s*\/\s*m|\s*por\s*m)/i,
        /\$?\s?(?:us\.?|usd)\s?([\d.,]+)(?!\s*\/\s*m|\s*por\s*m)/i,
        /(?:precio|desde)\s*:?\s*bs\.?\s?([\d.,]+)/i
    ];

    for (let i = 0; i < patronesDesc.length; i++) {
        const resultado = buscarPatron(descripcionLimpia, patronesDesc[i]);
        if (resultado && resultado[1]) {
            precioExplicitoDesc = parsePrecioMeta(resultado[1]);
            if (precioExplicitoDesc) break;
        }
    }

    const patronRango = /\$?\s?(?:us\.?|usd)\s?(\d+[.,]?\d*)\s*(?:-|a|hasta)\s*\$?\s?(?:us\.?|usd)\s?(\d+[.,]?\d*)/i;
    const matchRango = descripcionLimpia.match(patronRango);
    let precio_min_usd = null;
    let precio_max_usd = null;

    if (matchRango) {
        precio_min_usd = parsePrecioMeta(matchRango[1]);
        precio_max_usd = parsePrecioMeta(matchRango[2]);
    }

    let precio_final_usd = null;
    let precio_fue_normalizado = false;
    let moneda_original = "USD";

    if (precio_bruto && precio_bruto > 0) {
        if (currency_id === 1) {
            moneda_original = "BOB";
            precio_final_usd = Math.round(precio_bruto / CONFIG.TIPO_CAMBIO_USD_BS_OFICIAL);
            precio_fue_normalizado = true;
            fuente_precio = "json_normalizado";
        } else {
            precio_final_usd = Math.round(precio_bruto);
            fuente_precio = "json_usd";
        }
    } else if (precioExplicitoDesc && precioExplicitoDesc > 0) {
        precio_final_usd = Math.round(precioExplicitoDesc);
        fuente_precio = "descripcion_explicito";
    } else if (esMultiproyecto && precio_min_usd && precio_max_usd) {
        precio_final_usd = Math.round((precio_min_usd + precio_max_usd) / 2);
        fuente_precio = "json_fallback";
    }

    const es_rango_falso = (esMultiproyecto && precio_min_usd && precio_max_usd && 
                            precio_min_usd === precio_max_usd);
    const precio_conflicto = (precioExplicitoDesc && precio_bruto && 
                            Math.abs(precioExplicitoDesc - precio_bruto) > precio_bruto * 0.15);
    
    return {
        precio_usd: precio_final_usd,
        precio_usd_original: precio_bruto,
        precio_fue_normalizado,
        moneda_original,
        precio_min_usd,
        precio_max_usd,
        es_rango_falso: es_rango_falso,
        es_rango_falso_positivo: false,
        precio_conflicto: precio_conflicto,
        fuente_precio
    };
}

function extraerRangoPrecios(descripcion = "") {
    const desc = typeof descripcion === 'string' ? descripcion : "";
    const patronRango = /\$?\s?(?:us\.?|usd)\s?(\d+[.,]?\d*)\s*(?:-|a|hasta)\s*\$?\s?(?:us\.?|usd)\s?(\d+[.,]?\d*)/i;
    const match = desc.match(patronRango);
    if (match) {
        const min = parsePrecioMeta(match[1]);
        const max = parsePrecioMeta(match[2]);
        if (min && max && max > min) {
            return { precio_min_usd: min, precio_max_usd: max, es_rango: true };
        }
    }
    return { precio_min_usd: null, precio_max_usd: null, es_rango: false };
}

function convertirPrecioABolivianos(precio_usd, precio_fue_normalizado, tipo_cambio_detectado) {
    if (!precio_usd) return {
        precio_bs: null,
        tipo_cambio_usado: null,
        tipo_cambio_paralelo_usado: null
    };
    const tc_oficial = CONFIG.TIPO_CAMBIO_USD_BS_OFICIAL;
    const tc_paralelo = (tipo_cambio_detectado === 'paralelo' && precio_fue_normalizado) ? CONFIG.TIPO_CAMBIO_USD_BS_PARALELO : null;
    return {
        precio_bs: Math.round(precio_usd * tc_oficial),
        tipo_cambio_usado: tc_oficial,
        tipo_cambio_paralelo_usado: tc_paralelo
    };
}

function estimarPrecioPorM2(precio_usd, area_m2, zona = "default") {
    if (!precio_usd || !area_m2 || area_m2 === 0) {
        return { precio_m2: null, comparacion_media_zona: "sin_dato" };
    }
    const precio_m2 = precio_usd / area_m2;
    const media_zona = CONFIG.MEDIA_ZONA_USD_M2[zona] || CONFIG.MEDIA_ZONA_USD_M2["default"];
    let comparacion;
    if (precio_m2 > 1.4 * media_zona) comparacion = "muy_por_encima";
    else if (precio_m2 > 1.15 * media_zona) comparacion = "por_encima";
    else if (precio_m2 < 0.7 * media_zona) comparacion = "muy_por_debajo";
    else if (precio_m2 < 0.85 * media_zona) comparacion = "por_debajo";
    else comparacion = "normal";
    return { precio_m2, comparacion_media_zona: comparacion };
}

function detectarTipoCambio(descripcion = "") {
    if (!descripcion || typeof descripcion !== 'string') return "no_especificado";
    
    const desc = descripcion.toLowerCase();
    
    // Detectar TC paralelo
    if (/\b(tc\s*paralelo|cambio\s+paralelo|d√≥lar\s+blue|paralelo)\b/i.test(desc)) 
        return "paralelo";
    
    if (/\bpago\s+en\s+d√≥lares/i.test(desc)) 
        return "paralelo";
    
    // Detectar TC oficial
    if (/tc\.?\s*oficial|\btc\.?\s*[67]\b/i.test(desc)) 
        return "oficial";
    
    return "no_especificado";
}
// ============================================================================
// AGENTE, OFICINA, FOTOS
// ============================================================================

// ============================================================================
// üë§ extraerAgente v1.7.2 - ESTRUCTURA CORRECTA
// ============================================================================
function extraerAgente(agents) {
    let agente_nombre = null;
    let agente_telefono = null;

    if (agents && agents.length > 0) {
        const agent = agents[0];
        
        // ‚úÖ Buscar en agent.user (estructura correcta de Remax)
        if (agent.user) {
            agente_nombre = agent.user.name_to_show || null;
            agente_telefono = agent.user.phone_number || agent.user.mobile_phone || null;
            
            // Normalizar tel√©fono
            if (agente_telefono && !agente_telefono.startsWith('+')) {
                agente_telefono = `+${agente_telefono}`;
            }
        }
    }

    const url_whatsapp = agente_telefono 
        ? `https://wa.me/${agente_telefono.replace('+', '')}` 
        : null;

    return {
        agente_nombre,
        agente_telefono,
        url_whatsapp
    };
}

// ============================================================================
// üè¢ extraerOficina v1.7.2 - CON M√ÅS DATOS
// ============================================================================
function extraerOficina(agents) {
    let oficina_nombre = null;
    let oficina_telefono = null;
    let oficina_direccion = null;

    if (agents && agents.length > 0) {
        const agent = agents[0];
        
        if (agent.office) {
            oficina_nombre = agent.office.name || null;
            oficina_telefono = agent.office.phone || agent.office.phone_number || null;
            oficina_direccion = agent.office.address || agent.office.street_address || null;
            
            // Normalizar tel√©fono oficina
            if (oficina_telefono && !oficina_telefono.startsWith('+')) {
                oficina_telefono = `+${oficina_telefono}`;
            }
        }
    }

    return {
        oficina_nombre,
        oficina_telefono,
        oficina_direccion
    };
}

function extraerFotos(multimedias) {
    const fotos = [];
    if (multimedias && Array.isArray(multimedias)) {
        for (const media of multimedias) {
            if (media.link) {
                fotos.push(media.link);
            }
        }
    }
    const fotosUnicas = [...new Set(fotos)]
        .map(url => url.replace(/^http:/, 'https:'))
        .filter(url => url && url.startsWith('https://'));
    return {
        fotos_urls: fotosUnicas,
        cantidad_fotos: fotosUnicas.length,
        tiene_fotos: fotosUnicas.length > 0
    };
}

// ============================================================================
// MULTIPROYECTO
// ============================================================================

function detectarMultiproyecto(descripcion = "") {
    if (typeof descripcion !== 'string') return false;
    const desc = descripcion.toLowerCase();
    const tiene_multiples_dormitorios = /\d+\s*(?:,|y|o)\s*\d+\s+dormitorios?/i.test(desc);
    const tiene_varias_tipologias = /varias\s+(tipolog√≠as?|opciones)/i.test(desc);
    const tiene_diferentes_modelos = /diferentes\s+(tipolog√≠as?|modelos|plantas)/i.test(desc);
    const tiene_rango_areas = /de\s+\d+\s*m[¬≤2]\s+hasta\s+\d+\s*m[¬≤2]/i.test(desc);
    const tiene_desde_area = /(?:desde|a\s+partir\s+de|superficie\s+desde)\s+\d+\s*m[¬≤2]/i.test(desc);
    const tiene_precio_desde = /(?:precio\s+desde|desde\s+\$?\s?(?:us\.?|usd))\s?[\d.,]+/i.test(desc);
    const es_plural = /(?:departamentos|casas|monoambientes|unidades)\b/i.test(desc);
    const tiene_indicador_multiple = /(?:diferentes|varios|m√∫ltiples|variedad)\s+(?:tipos|modelos|opciones)/i.test(desc);
    const patrones_positivos = [
        tiene_multiples_dormitorios,
        tiene_varias_tipologias,
        tiene_diferentes_modelos,
        tiene_rango_areas,
        tiene_desde_area,
        tiene_precio_desde,
        es_plural,
        tiene_indicador_multiple
    ];
    const count = patrones_positivos.filter(Boolean).length;
    return count >= 2;
}

// ============================================================================
// üìê extraerArea v1.7.2 - CON SOPORTE PARA EMOJIS
// ============================================================================
function extraerArea(listing, descripcion = "") {
    let area_total_m2 = null;
    let fuente_confianza_area = "no_detectado";

    // 1Ô∏è‚É£ PRIORIDAD: JSON construction_area
    if (listing && listing.listing_information && listing.listing_information.construction_area) {
        const area = parseFloat(listing.listing_information.construction_area);
        if (!isNaN(area) && area > 0 && area < 10000) {
            return {
                area_total_m2: Math.round(area),
                fuente_confianza_area: "json_construction_area"
            };
        }
    }

    // 2Ô∏è‚É£ FALLBACK: Descripci√≥n con m√∫ltiples patrones
    const desc = typeof descripcion === 'string' ? descripcion : "";
    
    const patronesArea = [
        // ‚úÖ NUEVO: Patr√≥n con emojis checkmark
        /[‚úîÔ∏è‚úÖ‚òëÔ∏è‚úì]\s*(\d+(?:[.,]\d+)?)\s*m[t¬≤2]/i,
        
        // Patrones existentes
        /(\d+(?:[.,]\d+)?)\s*m[¬≤2]?\s*(?:de\s+)?(?:construcci√≥n|construidos|√°rea)/i,
        /(?:superficie|√°rea)\s*(?:de\s+)?(?:construcci√≥n|construida)?\s*:?\s*(\d+(?:[.,]\d+)?)\s*m[¬≤2]?/i,
        /(\d+(?:[.,]\d+)?)\s*(?:metros|mts)?\s*cuadrados?\s*(?:construidos|de\s+construcci√≥n)?/i,
        /√°rea\s+total\s*:?\s*(\d+(?:[.,]\d+)?)\s*m[¬≤2]?/i,
        /construcci√≥n\s*:?\s*(\d+(?:[.,]\d+)?)\s*m[¬≤2]?/i
    ];

    for (const patron of patronesArea) {
        const match = desc.match(patron);
        if (match && match[1]) {
            const area = parseFloat(match[1].replace(',', '.'));
            if (!isNaN(area) && area >= 10 && area < 10000) {
                return {
                    area_total_m2: Math.round(area),
                    fuente_confianza_area: "descripcion_patron"
                };
            }
        }
    }

    return { area_total_m2: null, fuente_confianza_area: "no_detectado" };
}

// ============================================================================
// üèóÔ∏è extraerEstructura v1.7.2 - CON VALIDACI√ìN ROBUSTA DE MONOAMBIENTE
// ============================================================================
function extraerEstructura(listing, descripcion, esMultiproyecto = false) {
    let dormitorios = null;
    let dormitorios_opciones = [];
    let dormitorios_categoria = "sin_informacion";
    let fuente_confianza_dormitorios = "no_definido";
    let es_monoambiente = false;
    let nivelDescripcion = "sin_descripcion";

    const desc = typeof descripcion === 'string' ? descripcion.toLowerCase() : "";
    
    // Nivel de descripci√≥n
    if (desc.length > 500) nivelDescripcion = "detallada";
    else if (desc.length > 100) nivelDescripcion = "basica";

    // ========================================================================
    // FUENTE PRIMARIA: JSON
    // ========================================================================
    if (listing && listing.listing_information && typeof listing.listing_information.number_bedrooms === 'number') {
        dormitorios = listing.listing_information.number_bedrooms;
        fuente_confianza_dormitorios = "json_system";
    }

    // ========================================================================
    // DETECCI√ìN DE MONOAMBIENTE CON VALIDACIONES ROBUSTAS
    // ========================================================================
    
    // Paso 1: Buscar menciones de monoambiente/studio
    const mencionaMonoambiente = /monoambiente|mono[\s-]?ambiente|estudio|studio/i.test(desc);
    
    // Paso 2: Validar que NO sea falso positivo
    if (mencionaMonoambiente) {
        // ‚ùå NO es monoambiente si menciona "dormitorio privado/independiente"
        const tieneDormitorioPrivado = /dormitorio\s+(?:privado|independiente|separado)/i.test(desc);
        
        // ‚ùå NO es monoambiente si JSON dice 1+ dormitorios
        const jsonDiceConDormitorios = dormitorios !== null && dormitorios > 0;
        
        // ‚ùå NO es monoambiente si menciona "1 dormitorio" expl√≠citamente
        const menciona1Dormitorio = /\b1\s+dormitorio\b/i.test(desc);
        
        // DECISI√ìN FINAL
        if (!tieneDormitorioPrivado && !jsonDiceConDormitorios && !menciona1Dormitorio) {
            es_monoambiente = true;
            dormitorios = 0;
            fuente_confianza_dormitorios = "descripcion_monoambiente";
        }
    }

    // ========================================================================
    // CATEGORIZACI√ìN DE DORMITORIOS
    // ========================================================================
    if (dormitorios !== null) {
        if (es_monoambiente || dormitorios === 0) {
            dormitorios_categoria = "monoambiente";
        } else if (dormitorios === 1) {
            dormitorios_categoria = "1_dormitorio";
        } else if (dormitorios === 2) {
            dormitorios_categoria = "2_dormitorios";
        } else if (dormitorios >= 3) {
            dormitorios_categoria = "3+_dormitorios";
        }
    }

    // ========================================================================
    // MULTIPROYECTO: Detectar rangos de dormitorios
    // ========================================================================
    if (esMultiproyecto) {
        const patronRango = /(\d+)\s*(?:a|y|,)\s*(\d+)\s+dormitorios?/i;
        const matchRango = desc.match(patronRango);
        
        if (matchRango) {
            const min = parseInt(matchRango[1]);
            const max = parseInt(matchRango[2]);
            
            for (let i = min; i <= max; i++) {
                dormitorios_opciones.push(i);
            }
            
            if (!dormitorios) {
                dormitorios = min;
            }
            dormitorios_categoria = "multiproyecto";
        }
    }

    return {
        dormitorios,
        dormitorios_opciones,
        dormitorios_categoria,
        fuente_confianza_dormitorios,
        es_monoambiente,
        nivelDescripcion
    };
}

// ============================================================================
// BA√ëOS
// ============================================================================

function extraerBanos(listing, descripcion) {
    let total = 0;
    let fuente_confianza_banos = "no_definido";
    let conflicto_banos = false;
    let tieneSocial = false;

    if (listing && listing.listing_information && typeof listing.listing_information.number_bathrooms === 'number') {
        total = listing.listing_information.number_bathrooms;
        fuente_confianza_banos = "json_system";
        const desc = typeof descripcion === 'string' ? descripcion.toLowerCase() : "";
        tieneSocial = /ba[√±n]o\s+(?:de\s+)?(?:visitas?|social)/i.test(desc);
        return { total, tieneSocial, fuente_confianza_banos, conflicto_banos };
    }

    const desc = typeof descripcion === 'string' ? descripcion.toLowerCase() : "";
    const matchSimple = desc.match(/(\d+)\s+ba[√±n]os?(?!\s+sociales?|\s+comunes?)/i);
    if (matchSimple) {
        const num = parseInt(matchSimple[1], 10);
        if (!isNaN(num) && num > 0 && num <= 10) {
            total = num;
            fuente_confianza_banos = "descripcion_simple";
        }
    }

    let banosContexto = total;
    const mencionaEnSuite = /\b(?:ba[√±n]o\s+(?:en\s+)?suite|en\s+suite|suite)\b/i.test(desc);
    const mencionaEdificio = /\b(?:edificio|condominio|proyecto|complejo)\s+.*\b(?:ba[√±n]o|suite)\b/i.test(desc);
    if (mencionaEnSuite && !mencionaEdificio) {
        banosContexto += 1;
    }
    const tieneBanoVisitas = /\b(?:ba[√±n]o\s+(?:de\s+)?(?:visitas?|social))\b/i.test(desc);
    const esAreaComun = /\b(?:edificio|√°reas?\s+comunes?|condominio|zonas?\s+comunes?)\s+.*\bba[√±n]o/i.test(desc);
    if (tieneBanoVisitas && !esAreaComun) {
        banosContexto += 1;
        tieneSocial = true;
    }

    let totalFinal = total;
    let fuenteFinal = fuente_confianza_banos;
    if (banosContexto > total && banosContexto <= 4) {
        totalFinal = banosContexto;
        fuenteFinal = "descripcion_contexto";
    }

    const es_monoambiente = /monoambiente|mono[\s-]?ambiente|estudio|studio/i.test(desc);
    if (totalFinal === 0 && fuenteFinal === 'no_definido') {
        if (es_monoambiente) {
            return { total: 1, tieneSocial, fuente_confianza_banos: "inferido_monoambiente", conflicto_banos: false };
        } else {
            return { total: 1, tieneSocial, fuente_confianza_banos: "por_defecto", conflicto_banos: false };
        }
    }

    return { total: totalFinal, tieneSocial, fuente_confianza_banos: fuenteFinal, conflicto_banos };
}

// ============================================================================
// MODALIDAD
// ============================================================================

function extraerModalidad(transactionType, descripcion = "") {
    if (transactionType && transactionType.name) {
        const m = transactionType.name.toLowerCase();
        if (/venta/.test(m)) return "venta";
        if (/renta|alquiler/.test(m)) return "alquiler";
        if (/anticr√©tico/.test(m)) return "anticretico";
    }
    const desc = typeof descripcion === 'string' ? descripcion.toLowerCase() : "";
    if (/venta|en\s+venta|for\s+sale/.test(desc)) return "venta";
    if (/alquiler|renta|arriendo|rental|for\s+rent/.test(desc)) return "alquiler";
    if (/anticr√©tico/.test(desc)) return "anticretico";
    return "no_especificado";
}

// ============================================================================
// AMENITIES
// ============================================================================

function extraerCaracteristicasHTML(html) {
    const caracteristicas = [];
    const regex = /<p class="text-gray-700">([^<]+)<\/p>/g;
    let match;
    while ((match = regex.exec(html)) !== null) {
        if (match[1] && match[1].trim()) {
            caracteristicas.push(match[1].trim());
        }
    }
    return caracteristicas;
}

function extraerAmenities(html, descripcion = "") {
    const amenitiesSet = new Set();
    const desc = typeof descripcion === 'string' ? descripcion.toLowerCase() : "";
    const AMENITIES_COMUNES = [
        "Piscina", "Churrasquera", "Sal√≥n de Eventos", "Co-working",
        "√Årea Social", "Seguridad 24/7", "Sauna/Jacuzzi", "Ascensor",
        "Parque Infantil", "Terraza/Balc√≥n", "Jard√≠n", "Lavadero",
        "Estacionamiento para Visitas", "Recepci√≥n", "Pet Friendly", "Gimnasio"
    ];
    const estadoAmenities = {};

    function registrar(amenity, valor, fuente, confianza) {
        estadoAmenities[amenity] = { valor, fuente, confianza };
    }

    const caracteristicasHTML = extraerCaracteristicasHTML(html);
    const mapeoCaracteristicas = {
        "Piscina": ["Piscina", "Pileta", "Pool"],
        "Gimnasio": ["Gimnasio", "Gym", "Fitness"],
        "Churrasquera": ["Churrasquera", "Parrilla", "BBQ", "Quincho"],
        "Sal√≥n de Eventos": ["Sal√≥n de Eventos", "Sal√≥n Social", "Event Room"],
        "Co-working": ["Co-working", "Coworking", "Espacio de Trabajo"],
        "√Årea Social": ["√Årea Social", "Zona Social", "Social Area"],
        "Seguridad 24/7": ["Seguridad 24", "Vigilancia", "Security", "Porter√≠a"],
        "Sauna/Jacuzzi": ["Sauna", "Jacuzzi", "Hidromasaje"],
        "Ascensor": ["Ascensor", "Elevador", "Lift"],
        "Parque Infantil": ["Parque Infantil", "Juegos", "Playground"],
        "Terraza/Balc√≥n": ["Terraza", "Balc√≥n"],
        "Jard√≠n": ["Jard√≠n", "√Åreas Verdes", "Garden"],
        "Lavadero": ["Lavadero", "√Årea de Lavado", "Laundry"],
        "Estacionamiento para Visitas": ["Estacionamiento Visitas", "Parking Visitas"],
        "Recepci√≥n": ["Recepci√≥n", "Lobby", "Reception"],
        "Pet Friendly": ["Pet Friendly", "Mascotas", "Pets"],
        "Gimnasio": ["Gimnasio", "Gym"]
    };

    for (const caract of caracteristicasHTML) {
        for (const [amenity, variantes] of Object.entries(mapeoCaracteristicas)) {
            for (const variante of variantes) {
                if (caract.toLowerCase().includes(variante.toLowerCase())) {
                    amenitiesSet.add(amenity);
                    registrar(amenity, true, "html_parsed", "alta");
                    break;
                }
            }
        }
    }

    for (const [amenity, variantes] of Object.entries(mapeoCaracteristicas)) {
        for (const variante of variantes) {
            if (desc.includes(variante.toLowerCase())) {
                amenitiesSet.add(amenity);
                if (!estadoAmenities[amenity]) {
                    registrar(amenity, true, "descripcion_text", "media");
                }
                break;
            }
        }
    }

    return {
        amenities: Array.from(amenitiesSet),
        estado_amenities: estadoAmenities
    };
}

// ============================================================================
// üõ†Ô∏è extraerEquipamiento v1.7.2 - CON DETECCI√ìN INTELIGENTE DE AMOBLADO
// ============================================================================
function extraerEquipamiento(html, descripcion = "") {
    const equipamiento = [];
    const desc = typeof descripcion === 'string' ? descripcion.toLowerCase() : "";
    
    // 1Ô∏è‚É£ Desde HTML parseado
    const caracteristicasHTML = extraerCaracteristicasHTML(html);
    
    const mapeoEquipamiento = {
        "Cocina Equipada": ["Cocina Equipada", "Cocina Americana"],
        "Aire Acondicionado": ["Aire Acondicionado", "AC", "Split", "Aire Acondicionado Central"],
        "Lavander√≠a": ["Lavanderia", "Lavander√≠a", "Area de Lavado"],
        "Amoblado": ["Amoblado", "Muebles Incluidos", "Furnished"],
        "Roperos Empotrados": ["Roperos Empotrados", "Closet", "Walk-in Closet"],
        "Ba√±o con Box": ["Ba√±o con Box", "Box de Ducha", "Shower Enclosure"],
        "Campana Extractora": ["Campana Extractora", "Extractor", "Hood"],
        "Microondas": ["Microondas", "Microwave"],
        "Secadora": ["Secadora", "Dryer"],
        "Lavadora": ["Lavadora", "Washer"],
        "Horno": ["Horno", "Oven"],
        "Calef√≥n": ["Calefon", "Calef√≥n", "Calentador"]
    };

    for (const caracteristica of caracteristicasHTML) {
        for (const [equip, variantes] of Object.entries(mapeoEquipamiento)) {
            if (variantes.some(v => caracteristica.toLowerCase().includes(v.toLowerCase()))) {
                if (!equipamiento.includes(equip)) {
                    equipamiento.push(equip);
                }
                break;
            }
        }
    }

    // 2Ô∏è‚É£ DETECCI√ìN INTELIGENTE DE AMOBLADO (Century21 v16.3)
    
    // Criterio 1: Menciona "amoblado" expl√≠citamente
    const mencionaAmobladoExplicito = /(?:totalmente\s+)?amoblado|precio\s+amoblado|furnished|viene\s+amoblado/i.test(desc);
    
    // Criterio 2: NO es contexto de √°reas comunes
    const esSoloAreaComun = /(?:√°reas?|zonas?)\s+(?:comunes?|sociales?).*amoblad/i.test(desc);
    
    // Criterio 3: Lista muebles completos (al menos 4 de estos)
    const muebles = {
        cama: /\bcama\b|sommier|colch√≥n/i.test(desc),
        ropero: /\bropero|closet|armario|vestidor\s+amoblado/i.test(desc),
        mesa: /\bmesa\b|comedor|escritorio|mes√≥n/i.test(desc),
        sillas: /\bsillas?|sillones?|sof√°|sala\s+de\s+estar/i.test(desc),
        cocina_equipada: /cocina\s+(?:totalmente\s+)?equipada|menaje\s+completo|heladera|refrigeradora|microondas/i.test(desc)
    };
    
    const cantidadMuebles = Object.values(muebles).filter(Boolean).length;
    
    // DECISI√ìN FINAL AMOBLADO
    if (mencionaAmobladoExplicito && !esSoloAreaComun) {
        if (!equipamiento.includes("Amoblado")) {
            equipamiento.push("Amoblado");
        }
    } else if (cantidadMuebles >= 4 && muebles.cama && muebles.cocina_equipada) {
        // Si tiene 4+ muebles incluyendo cama y cocina ‚Üí est√° amoblado
        if (!equipamiento.includes("Amoblado")) {
            equipamiento.push("Amoblado");
        }
    }

    // 3Ô∏è‚É£ Resto del equipamiento desde descripci√≥n
    if ((/cocina\s+(americana|equipada)/i.test(desc) || /\bequipada\b/i.test(desc)) && !equipamiento.includes("Cocina Equipada")) {
        equipamiento.push("Cocina Equipada");
    }
    if (/aire\s+acondicionado|split|ac/i.test(desc) && !equipamiento.includes("Aire Acondicionado")) {
        equipamiento.push("Aire Acondicionado");
    }
    if (/lavander[i√≠]a|√°rea\s+de\s+lavado|laundry\s+room/i.test(desc) && !equipamiento.includes("Lavander√≠a")) {
        equipamiento.push("Lavander√≠a");
    }
    if (/roperos?\s+empotrados?|cl[o√≥]set|walk-in/i.test(desc) && !equipamiento.includes("Roperos Empotrados")) {
        equipamiento.push("Roperos Empotrados");
    }
    if (/box\s+de\s+ba√±o|mampara|shower\s+enclosure/i.test(desc) && !equipamiento.includes("Ba√±o con Box")) {
        equipamiento.push("Ba√±o con Box");
    }
    if (/extractor|hood|campana/i.test(desc) && !equipamiento.includes("Campana Extractora")) {
        equipamiento.push("Campana Extractora");
    }
    if (/microondas|microwave/i.test(desc) && !equipamiento.includes("Microondas")) {
        equipamiento.push("Microondas");
    }
    if (/secadora|dryer/i.test(desc) && !equipamiento.includes("Secadora")) {
        equipamiento.push("Secadora");
    }
    if (/lavadora|washer/i.test(desc) && !equipamiento.includes("Lavadora")) {
        equipamiento.push("Lavadora");
    }
    if (/horno|oven/i.test(desc) && !equipamiento.includes("Horno")) {
        equipamiento.push("Horno");
    }
    if (/calef[√≥o]n|calentador/i.test(desc) && !equipamiento.includes("Calef√≥n")) {
        equipamiento.push("Calef√≥n");
    }

    return [...new Set(equipamiento)];
}

// ============================================================================
// üÖøÔ∏è extraerEstacionamiento v1.0 - Estados Expl√≠citos
// ============================================================================
function extraerEstacionamiento(descripcion = "") {
    try {
        const desc = typeof descripcion === 'string' ? descripcion.toLowerCase() : "";
        
        // ‚ùå Sin estacionamiento expl√≠cito
        if (/sin\s+(?:estacionamiento|parqueo|parking)/i.test(desc)) {
            return "no_incluido";
        }
        
        // ‚úÖ Incluye estacionamiento DE LA PROPIEDAD
        // Evitar menciones solo de visitas/edificio
        const patronPropiedad = /(?:incluye|con|cuenta\s+con|\d+)\s+(?:estacionamiento|parqueo|parking)(?!\s+(?:para\s+)?visita)/i;
        
        if (patronPropiedad.test(desc)) {
            return "incluido";
        }
        
        // ‚ùì No menciona
        return "sin_confirmar";
        
    } catch (error) {
        return "sin_confirmar";
    }
}
// ============================================================================
// GPS
// ============================================================================

function extraerGPS(location) {
    let latitud = null;           // ‚Üê NUEVO
    let longitud = null;          // ‚Üê NUEVO
    let coordenadas_gps = null;
    let zona_validada_gps = null;
    let metodo_gps = "no_detectado";

    if (location && location.latitude && location.longitude) {
        const lat = parseFloat(location.latitude);
        const lon = parseFloat(location.longitude);
        if (!isNaN(lat) && !isNaN(lon)) {
            latitud = lat;                    // ‚Üê NUEVO
            longitud = lon;                   // ‚Üê NUEVO
            coordenadas_gps = `${lat},${lon}`;
            metodo_gps = "json_location";
            if (lat >= -17.85 && lat <= -17.70 && lon >= -63.25 && lon <= -63.10) {
                zona_validada_gps = "Equipetrol";
            }
        }
    }

    return { latitud, longitud, coordenadas_gps, zona_validada_gps, metodo_gps };  // ‚Üê MODIFICADO
}

function inferirZonaDesdeTexto(descripcion = "") {
    const desc = typeof descripcion === 'string' ? descripcion.toLowerCase() : "";
    const zonasConocidas = ["equipetrol", "urubo", "las palmas", "los cusis"];
    for (const zona of zonasConocidas) {
        if (desc.includes(zona)) {
            return zona.charAt(0).toUpperCase() + zona.slice(1);
        }
    }
    return null;
}

// ============================================================================
// NOMBRE EDIFICIO
// ============================================================================

function extraerNombreEdificio(title, descripcion, url) {
    let nombre_edificio = null;
    let fuente_nombre = "no_detectado";
    let nivel_confianza = 0;
    let id_proyecto_master_sugerido = null;
    let metodo_match = null;

    if (title && typeof title === 'string') {
        const titleLimpio = title.replace(/\s*[-|]\s*remax.*/i, '').trim();
        const matchEn = titleLimpio.match(/en\s+([A-Z][a-zA-Z√°√©√≠√≥√∫√±\s]+)$/i);
        if (matchEn) {
            let candidato = limpiarZonasGeograficas(matchEn[1].trim());
            if (validarNombreLimpio(candidato)) {
                const fuzzyResult = validarConProyectos(candidato, PROYECTOS_MASTER);
                if (fuzzyResult && fuzzyResult.match && fuzzyResult.score >= 70) {
                    nombre_edificio = fuzzyResult.proyecto.nombre_oficial;
                    fuente_nombre = "title_fuzzy_matched";
                    nivel_confianza = fuzzyResult.score / 100;
                    id_proyecto_master_sugerido = fuzzyResult.proyecto.id_proyecto_master;
                    metodo_match = "fuzzy_extractor";
                    return { nombre_edificio, fuente_nombre, nivel_confianza, id_proyecto_master_sugerido, metodo_match };
                } else {
                    nombre_edificio = capitalizarNombre(candidato);
                    fuente_nombre = "title_validated";
                    nivel_confianza = 0.75;
                    return { nombre_edificio, fuente_nombre, nivel_confianza, id_proyecto_master_sugerido, metodo_match };
                }
            }
        }
    }

    const desc = typeof descripcion === 'string' ? descripcion : "";
    const matchProyecto = desc.match(/proyecto\s+([A-Z][a-z\s]{2,})\s+by\s+/i);
    if (matchProyecto) {
        let candidato = limpiarZonasGeograficas(matchProyecto[1].trim());
        if (validarNombreLimpio(candidato)) {
            const fuzzyResult = validarConProyectos(candidato, PROYECTOS_MASTER);
            if (fuzzyResult && fuzzyResult.match && fuzzyResult.score >= 70) {
                nombre_edificio = fuzzyResult.proyecto.nombre_oficial;
                fuente_nombre = "descripcion_fuzzy_matched";
                nivel_confianza = fuzzyResult.score / 100;
                id_proyecto_master_sugerido = fuzzyResult.proyecto.id_proyecto_master;
                metodo_match = "fuzzy_extractor";
                return { nombre_edificio, fuente_nombre, nivel_confianza, id_proyecto_master_sugerido, metodo_match };
            } else {
                nombre_edificio = capitalizarNombre(candidato);
                fuente_nombre = "descripcion_proyecto_by";
                nivel_confianza = 0.70;
                return { nombre_edificio, fuente_nombre, nivel_confianza, id_proyecto_master_sugerido, metodo_match };
            }
        }
    }

    const matchEdificio = desc.match(/edificio\s+([A-Z][a-z\s]{2,})/i);
    if (matchEdificio) {
        let candidato = limpiarZonasGeograficas(matchEdificio[1].trim());
        if (validarNombreLimpio(candidato)) {
            nombre_edificio = capitalizarNombre(candidato);
            fuente_nombre = "descripcion_edificio";
            nivel_confianza = 0.65;
            return { nombre_edificio, fuente_nombre, nivel_confianza, id_proyecto_master_sugerido, metodo_match };
        }
    }

    return { nombre_edificio: null, fuente_nombre: "no_detectado", nivel_confianza: 0, id_proyecto_master_sugerido: null, metodo_match: null };
}

function validarNombreLimpio(nombre) {
    if (!nombre || nombre.length < 3 || nombre.length > 60) return false;
    const nombreNorm = normalizarTextoParaMatch(nombre);
    for (const termino of BLACKLIST_CRITICA) {
        if (nombreNorm === normalizarTextoParaMatch(termino)) return false;
    }
    return /[a-z]/i.test(nombre) && !/^\d+$/.test(nombre.trim());
}

function capitalizarNombre(nombre) {
    if (!nombre) return '';
    return nombre.toLowerCase().split(' ')
        .map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
}

function validarConProyectos(nombreExtraido, proyectos) {
    if (!nombreExtraido || !proyectos || proyectos.length === 0) return null;
    const nombreNorm = normalizarTextoParaMatch(nombreExtraido);
    const stopWords = ['condominio', 'edificio', 'torre', 'residencial', 'proyecto'];
    let mejorMatch = null;
    let mejorScore = 0;

    for (const proyecto of proyectos) {
        const proyectoData = proyecto.json || proyecto;
        if (!proyectoData.nombre_oficial) continue;

        const nombreOficialNorm = normalizarTextoParaMatch(proyectoData.nombre_oficial);
        if (nombreNorm === nombreOficialNorm) {
            return { match: true, score: 100, proyecto: proyectoData };
        }

        if (proyectoData.alias_conocidos && Array.isArray(proyectoData.alias_conocidos)) {
            for (const alias of proyectoData.alias_conocidos) {
                const aliasNorm = normalizarTextoParaMatch(alias);
                if (nombreNorm === aliasNorm) {
                    return { match: true, score: 100, proyecto: proyectoData };
                }
            }
        }

        const score = wordIntersection(nombreExtraido, proyectoData.nombre_oficial);
        if (score > mejorScore) {
            mejorScore = score;
            mejorMatch = proyectoData;
        }
    }

    if (mejorScore >= 0.65 && mejorMatch) {
        return { match: true, score: Math.round(mejorScore * 100), proyecto: mejorMatch };
    }

    return null;
}

// ============================================================================
// ESTADO CONSTRUCCI√ìN
// ============================================================================

function extraerEstadoConstruccionYEntrega(descripcion, esMultiproyecto = false) {
    const desc = typeof descripcion === 'string' ? descripcion.toLowerCase() : "";
    let estado_construccion = "entrega_inmediata";
    let fecha_entrega_estimada = null;
    let porcentaje_avance_construccion = null;

    if (/en\s+construcci√≥n|construy√©ndose|en\s+obra/i.test(desc)) {
        estado_construccion = "en_construccion";
        const matchPorcentaje = desc.match(/(\d+)%\s+(?:de\s+)?(?:avance|completado|construido)/i);
        if (matchPorcentaje) {
            porcentaje_avance_construccion = parseInt(matchPorcentaje[1], 10);
        }
        const matchFecha = desc.match(/entrega\s+(?:en|:)?\s*(\w+\s+\d{4}|\d{1,2}\/\d{4})/i);
        if (matchFecha) {
            fecha_entrega_estimada = matchFecha[1].trim();
        }
    } else if (/preventa|pre-venta|en\s+planos/i.test(desc)) {
        estado_construccion = "preventa";
        const matchFecha = desc.match(/entrega\s+(?:en|:)?\s*(\w+\s+\d{4}|\d{1,2}\/\d{4})/i);
        if (matchFecha) {
            fecha_entrega_estimada = matchFecha[1].trim();
        }
    }

    return { estado_construccion, fecha_entrega_estimada, porcentaje_avance_construccion };
}

// ============================================================================
// VALIDACIONES (MANTIENEN FLAGS PARA MERGE)
// ============================================================================

function validarConflictos(data, esMultiproyecto = false) {
    const conflictos = [];
    const area = data.area_total_m2 || 0;
    const precio = data.precio_usd || 0;
    const dormitorios = data.dormitorios;
    const banos = data.banos;

    if (precio > 0 && area > 0) {
        const precioM2 = precio / area;
        if (precioM2 > 10000) {
            conflictos.push({ tipo: "precio_m2_muy_alto", descripcion: `Precio/m¬≤ sospechoso: $${Math.round(precioM2)}/m¬≤`, severidad: "alta" });
        } else if (precioM2 < 300) {
            conflictos.push({ tipo: "precio_m2_muy_bajo", descripcion: `Precio/m¬≤ sospechoso: $${Math.round(precioM2)}/m¬≤`, severidad: "media" });
        }
    }

    if (dormitorios !== null && dormitorios >= 0 && area > 0) {
        const areaMinEsperada = dormitorios === 0 ? 25 : (dormitorios * 30);
        const areaMaxEsperada = dormitorios === 0 ? 60 : (dormitorios * 80);
        if (area < areaMinEsperada) {
            conflictos.push({ tipo: "area_inconsistente_dormitorios", descripcion: `√Årea ${area}m¬≤ muy peque√±a para ${dormitorios} dorm.`, severidad: "media" });
        } else if (area > areaMaxEsperada && !esMultiproyecto) {
            conflictos.push({ tipo: "area_inconsistente_dormitorios", descripcion: `√Årea ${area}m¬≤ muy grande para ${dormitorios} dorm.`, severidad: "baja" });
        }
    }

    if (dormitorios !== null && banos !== null) {
        if (banos > dormitorios + 2 && dormitorios > 0) {
            conflictos.push({ tipo: "banos_excesivos", descripcion: `${banos} ba√±os para ${dormitorios} dorm. parece excesivo`, severidad: "baja" });
        }
    }

    if (!precio || precio === 0) {
        conflictos.push({ tipo: "precio_faltante", descripcion: "No se detect√≥ precio", severidad: "alta" });
    }

    if (!area || area === 0) {
        conflictos.push({ tipo: "area_faltante", descripcion: "No se detect√≥ √°rea", severidad: "media" });
    }

    return conflictos;
}

function validarConflictoNombreEdificio(data) {
    const conflictos = [];
    const nombre = data.nombre_edificio;
    const confianza = data.nombre_edificio_nivel_confianza || 0;

    if (!nombre || nombre.length < 3) {
        conflictos.push({ tipo: "nombre_edificio_faltante", descripcion: "No se detect√≥ nombre", severidad: "media" });
    }

    if (/^(edificio|condominio|torre|residencial)$/i.test(nombre)) {
        conflictos.push({ tipo: "nombre_edificio_generico", descripcion: `Nombre gen√©rico: '${nombre}'`, severidad: "baja" });
    }

    if (confianza < 0.7) {
        conflictos.push({ tipo: "nombre_edificio_baja_confianza", descripcion: `Confianza baja: ${confianza.toFixed(2)}`, severidad: confianza < 0.5 ? "media" : "baja" });
    }

    return conflictos;
}

function calcularNivelConfianza(data, conflictos, esMultiproyecto = false) {
    let confianza = 1.0;

    if (conflictos.some(c => c.severidad === "alta")) confianza -= 0.25;
    if (conflictos.some(c => c.severidad === "media")) confianza -= 0.15;
    if (conflictos.filter(c => c.severidad === "baja").length > 0) confianza -= 0.05;

    if (!data.precio_usd) confianza -= 0.30;
    if (data.fuente_precio === "json_fallback" && esMultiproyecto) confianza -= 0.20;
    if (data.fuente_precio === "no_detectado") confianza -= 0.20;
    if (!data.coordenadas_gps) confianza -= 0.10;

    if (!data.area_total_m2 || data.area_total_m2 === 0) {
        confianza -= 0.20;
    }

    if (data.fuente_precio === "descripcion_explicito_corregido" || data.precio_fue_normalizado) confianza += 0.10;
    if (data.coordenadas_gps && data.metodo_gps === "json_location") confianza += 0.05;
    if (data.fuente_confianza_banos === "json_system") confianza += 0.05;
    if (data.nivel_descripcion === "detallada") confianza += 0.05;

    if (typeof data.nombre_edificio_nivel_confianza === "number") {
        const conf = data.nombre_edificio_nivel_confianza;
        if (conf >= 0.9) confianza += 0.03;
        else if (conf >= 0.7) confianza += 0.00;
        else if (conf >= 0.5) confianza -= 0.10;
        else confianza -= 0.20;
    } else {
        confianza -= 0.10;
    }

    return Math.max(0, Math.
min(1, confianza));
}
// ============================================================================
// MAPEADOR PRINCIPAL
// ============================================================================

function mapearRemax(listing, html, url, idOriginal) {
    try {
        const statusInactivo = listing.status_listing?.name && /inactiva|cancelada|vendida|alquilada/i.test(listing.status_listing.name);
        if (statusInactivo) {
            return { es_inactiva: true, razon: `Estado: ${listing.status_listing.name}` };
        }

        const descripcion = listing.description_website || "";
        const es_multiproyecto = detectarMultiproyecto(descripcion);
        const codigo = listing.MLSID || null;
        const tipo_propiedad_original = (listing.listing_information?.subtype_property?.name || 'No especificado').toString();
        const fecha_publicacion = listing.date_of_listing || listing.created_at || null;
        const fecha_de_ultima_modificacion = listing.updated_at || fecha_publicacion || null;

        const gpsData = extraerGPS(listing.location);
        const estructuraData = extraerEstructura(listing, descripcion, es_multiproyecto);
        const agenteData = extraerAgente(listing.agents);
        const oficinaData = extraerOficina(listing.agents);
        const fotosData = extraerFotos(listing.multimedias);
        const precioData = extraerPrecio(listing, descripcion, es_multiproyecto);
        const tipo_cambio_detectado = detectarTipoCambio(descripcion);  // ‚úÖ SOLO UNA VEZ
        const areasData = extraerArea(listing, descripcion);
        const banosData = extraerBanos(listing, descripcion);
        const { amenities, estado_amenities } = extraerAmenities(html, descripcion);
        const equipamiento = extraerEquipamiento(html, descripcion);
        const edificioData = extraerNombreEdificio(listing.title, descripcion, url);
        
        // ‚ùå ELIMINADA l√≠nea duplicada: const tipo_cambio_detectado = detectarTipoCambio(descripcion);
        
        const conversionBs = convertirPrecioABolivianos(precioData.precio_usd, precioData.precio_fue_normalizado, tipo_cambio_detectado);
        const estadoData = extraerEstadoConstruccionYEntrega(descripcion, es_multiproyecto);
        const estacionamientoData = extraerEstacionamiento(descripcion);

        const area_final = areasData.area_total_m2;
        const fuente_area_final = areasData.fuente_confianza_area;

        const precioZonalData = estimarPrecioPorM2(precioData.precio_usd, area_final, gpsData.zona_validada_gps || "default");
        const comparacion = precioZonalData.comparacion_media_zona || "sin_dato";
        const precio_m2 = precioZonalData.precio_m2 ? Math.round(precioZonalData.precio_m2) : null;
        
        // üÜï v1.7.2: Calcular precio_sospechoso
        const precio_sospechoso = (comparacion === "muy_por_encima" ||   // ‚úÖ CORREGIDO
                                   comparacion === "muy_por_debajo");
        
        // ‚úÖ AHORA S√ç declarar data
        const data = {};
        
        data.id_original = idOriginal;
        data.codigo_propiedad = codigo;
        data.url_propiedad = url;
        data.tipo_propiedad_original = tipo_propiedad_original;
        data.agente_nombre = agenteData.agente_nombre;
        data.agente_telefono = agenteData.agente_telefono;
        data.url_whatsapp = agenteData.url_whatsapp;
        data.oficina_nombre = oficinaData.oficina_nombre;
        data.oficina_telefono = oficinaData.oficina_telefono;
        data.oficina_direccion = oficinaData.oficina_direccion;
        data.fotos_urls = fotosData.fotos_urls;
        data.cantidad_fotos = fotosData.cantidad_fotos;
        data.descripcion = descripcion;
        data.es_multiproyecto = es_multiproyecto;
        data.estado_construccion = estadoData.estado_construccion;
        data.fecha_entrega_estimada = estadoData.fecha_entrega_estimada;
        data.porcentaje_avance_construccion = estadoData.porcentaje_avance_construccion;
        data.tipo_operacion = extraerModalidad(listing.transaction_type, descripcion);
        data.fecha_publicacion = fecha_publicacion;
        data.fecha_de_ultima_modificacion = fecha_de_ultima_modificacion;
        data.updatedAt = fecha_de_ultima_modificacion; 
        data.fuente_fecha_publicacion = "json_date_of_listing";
        data.fecha_scraping = new Date().toISOString();
        data.scraper_version = "1.9";
        data.precio_usd = precioData.precio_usd;
        data.precio_usd_original = precioData.precio_usd_original;
        data.precio_fue_normalizado = precioData.precio_fue_normalizado;
        data.precio_usd_actualizado = precioData.precio_usd;
        data.requiere_actualizacion_precio = precioData.precio_fue_normalizado || (precioData.moneda_original === "BOB"); 
        data.precio_min_usd = precioData.precio_min_usd;
        data.precio_max_usd = precioData.precio_max_usd;
        data.es_rango_falso = precioData.es_rango_falso;
        data.es_rango_falso_positivo = precioData.es_rango_falso_positivo;
        data.moneda_original = precioData.moneda_original;
        data.fuente_precio = precioData.fuente_precio;
        data.precio_bs = conversionBs.precio_bs;
        data.tipo_cambio_usado = conversionBs.tipo_cambio_usado;
        data.tipo_cambio_paralelo_usado = conversionBs.tipo_cambio_paralelo_usado;
        data.precio_m2 = precio_m2;
        data.comparacion_media_zona = comparacion;
        
        // üÜï v1.7.2: Asignar nuevos campos
        data.precio_sospechoso = precio_sospechoso;  // ‚úÖ DESPU√âS de declarar data
        data.tipo_cambio_detectado = tipo_cambio_detectado;  // ‚úÖ DESPU√âS de declarar data
        data.precio_conflicto = precioData.precio_conflicto;
        data.area_total_m2 = area_final;
        data.fuente_confianza_area = fuente_area_final;
        data.dormitorios = estructuraData.dormitorios;
        data.dormitorios_opciones = estructuraData.dormitorios_opciones;
        data.dormitorios_categoria = estructuraData.dormitorios_categoria;
        data.fuente_confianza_dormitorios = estructuraData.fuente_confianza_dormitorios;
        data.es_monoambiente = estructuraData.es_monoambiente;
        data.banos = banosData.total;
        data.fuente_confianza_banos = banosData.fuente_confianza_banos;
        data.conflicto_banos = banosData.conflicto_banos;
        data.amenities = amenities;
        data.estado_amenities = estado_amenities;
        data.equipamiento = equipamiento;
        data.piscina = amenities.includes("Piscina");
        data.seguridad = amenities.includes("Seguridad 24/7");
        data.amoblado = equipamiento.includes("Amoblado");
        data.estacionamientos = estacionamientoData;
        data.nombre_edificio = edificioData.nombre_edificio;
        data.fuente_nombre_edificio = edificioData.fuente_nombre;
        data.nombre_edificio_nivel_confianza = edificioData.nivel_confianza;
        data.id_proyecto_master_sugerido = edificioData.id_proyecto_master_sugerido;
        data.metodo_match = edificioData.metodo_match;
        data.coordenadas_gps = gpsData.coordenadas_gps;
        data.latitud = gpsData.latitud;        // ‚Üê AGREGAR
        data.longitud = gpsData.longitud;      // ‚Üê AGREGAR
        data.zona_validada_gps = gpsData.zona_validada_gps;
        data.metodo_gps = gpsData.metodo_gps;
        data.nivel_descripcion = estructuraData.nivelDescripcion;

        const conflictos = [...validarConflictos(data, es_multiproyecto), ...validarConflictoNombreEdificio(data)];
        const nivel_confianza_general = calcularNivelConfianza(data, conflictos, es_multiproyecto);
        data.conflictos = conflictos;
        data.nivel_confianza_general = nivel_confianza_general;
        data.requiere_revision_humana = conflictos.some(c => c.severidad === "alta") || nivel_confianza_general < 0.6;
        data.extraccion_exitosa = true;

        return data;
    } catch (error) {
        return { error: true, mensaje: `Error en extractor: ${error.message}`, etapa: "mapeo" };
    }
}

// ============================================================================
// EJECUCI√ìN PRINCIPAL
// ============================================================================

try {
    const inactivaTemprana = detectarInactivaTemprana(html);
    if (inactivaTemprana) {
        return { json: { id_propiedad: idOriginal, datos_json: inactivaTemprana } };
    }

    const match = html.match(/<div id="app" data-page="([^"]+)">/);
    if (match) {
        const jsonStr = match[1].replace(/&quot;/g, '"').replace(/&amp;/g, '&');
        try {
            const data = JSON.parse(jsonStr);
            const status = data.props?.listing?.status_listing?.name;
            if (status && /inactiva|cancelada/i.test(status)) {
                return { json: { id_propiedad: idOriginal, datos_json: { es_inactiva: true, razon: `Estado: ${status}` } } };
            }
        } catch (e) {}
    }

    if (!html || html.length < 300) {
        return { json: { id_propiedad: idOriginal, datos_json: { error: true, mensaje: `HTML incompleto (${html?.length || 0})`, etapa: "validacion_html" } } };
    }

    const listing = parsearDataPage(html);
    const datos = mapearRemax(listing, html, itemData.url, idOriginal);

    if (datos && datos.error) {
        return { json: { id_propiedad: idOriginal, datos_json: datos } };
    }

    if (datos && datos.es_inactiva) {
        return { json: { id_propiedad: idOriginal, datos_json: datos } };
    }

    datos.extraccion_exitosa = true; 

     return { 
        json: {
            _internal_id: idOriginal,
            ...datos
        }
    };

} catch (error) {
    console.error("‚ùå Error fatal:", error.message);
    return {
        json: {
            id_propiedad: idOriginal,
            datos_json: {
                error: true,
                mensaje: `Error fatal: ${error.message}`,
                etapa: "principal",
                stack: error.stack
            }
        }
    };
}